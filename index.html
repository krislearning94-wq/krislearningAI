<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KRIS Learning IA ‚Äî v2.4 (Encuesta confidencial para docente)</title>
  <style>
    /* ====== Design System (UI Glow) ====== */
    :root{
      /* Base (dark default) */
      --bg: #0b0f16;
      --bg-grad: radial-gradient(1200px 600px at 10% -10%, #1e2a52 0%, transparent 55%),
                  radial-gradient(1000px 500px at 110% 10%, #222c5a 0%, transparent 45%),
                  linear-gradient(180deg, #0b0f16 0%, #0a0e14 100%);
      --fg: #eaf0ff;
      --muted:#9da8c1;
      --card: rgba(21, 27, 40, .7);
      --glass: rgba(255,255,255,.06);
      --line: rgba(255,255,255,.12);

      --brand:#86b0ff;     /* primario */
      --brand-2:#7ef29a;   /* acento */
      --brand-3:#ffd479;   /* warn */
      --danger:#ff6b6b;

      --shadow-1: 0 10px 30px rgba(0,0,0,.25), 0 1px 0 rgba(255,255,255,.05) inset;
      --shadow-2: 0 15px 45px rgba(18, 33, 75, .45);
      --ring: 0 0 0 3px rgba(134,176,255,.35);

      --radius-l: 16px;
      --radius-s: 12px;

      --header-fg:#fff;
      --pill-bg: rgba(255,255,255,.07);
      --pill-br: rgba(255,255,255,.15);
      --pill-fg:#eaf0ff;

      --table-head: rgba(255,255,255,.06);
      --focus: #86b0ff;
      --ok: #7ef29a;
      --warn: #ffd479;
      --bad: #ff7b7b;
    }
    /* Light theme */
    [data-theme="light"]{
      --bg:#f4f7ff;
      --bg-grad: radial-gradient(1200px 600px at -10% -10%, #dfe7ff 0%, transparent 55%),
                  radial-gradient(1000px 500px at 110% 0%, #e7f6ff 0%, transparent 45%),
                  linear-gradient(180deg, #f4f7ff 0%, #f8fbff 100%);
      --fg:#1a2233;
      --muted:#607190;
      --card:#ffffffea;
      --glass: rgba(10, 30, 60, .04);
      --line:#e6ecf5;
      --brand:#1a73e8;
      --brand-2:#0b8c46;
      --brand-3:#b78000;
      --danger:#b3261e;
      --shadow-1: 0 10px 24px rgba(10,20,40,.08), 0 1px 0 rgba(255,255,255,.6) inset;
      --shadow-2: 0 14px 38px rgba(20,35,80,.12);
      --ring: 0 0 0 3px rgba(26,115,232,.18);
      --header-fg:#0e1a2b;
      --pill-bg:#eef4ff;
      --pill-br:#dfe7ff;
      --pill-fg:#1a2233;
      --table-head:#f3f6fb;
      --focus:#1a73e8;
      --ok:#0e8b50;
      --warn:#b78000;
      --bad:#b3261e;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
      color:var(--fg);
      background: var(--bg-grad);
      background-attachment: fixed;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      letter-spacing:.2px;
    }

    /* ===== Header ===== */
    header{
      position: sticky; top:0; z-index:50;
      background: linear-gradient(180deg, rgba(0,0,0,.35), transparent);
      backdrop-filter: blur(10px);
    }
    header .container{
      max-width:1200px;margin:0 auto;
      display:flex;align-items:center;justify-content:space-between;gap:.8rem;
      padding:16px 16px;
    }
    .brand{ display:flex;align-items:center;gap:.75rem; }
    .brand-logo{
      width:36px;height:36px;border-radius:12px;
      background: conic-gradient(from 210deg, var(--brand), var(--brand-2), var(--brand));
      box-shadow: 0 0 0 6px rgba(134,176,255,.12);
    }
    h1{margin:0;font-size:1.05rem;color:var(--header-fg)}
    .container{max-width:1200px;margin:18px auto;padding:0 16px}

    /* ===== Landing Hero ===== */
    .hero{
      max-width:1200px;margin:24px auto 8px; padding: 0 16px;
      display:grid; grid-template-columns: 1.2fr 1fr; gap: 18px; align-items:center;
    }
    .hero-card{
      background: linear-gradient(180deg, var(--card), var(--glass));
      border: 1px solid var(--line);
      border-radius: 22px;
      padding: 28px; box-shadow: var(--shadow-1);
      position: relative; overflow: hidden;
    }
    .hero h2{font-size: clamp(1.6rem, 3.3vw, 2.4rem); margin:.2rem 0 .6rem}
    .hero p{font-size: clamp(.95rem, 1.6vw, 1.04rem); color:var(--muted); margin:.2rem 0 1rem}
    .hero-cta{display:flex;gap:.6rem;flex-wrap:wrap;margin-top:.4rem}
    .hero-badges{display:flex;gap:.4rem;flex-wrap:wrap;margin:.6rem 0}
    .hero .badge{background: var(--pill-bg); border:1px solid var(--pill-br); color: var(--pill-fg)}
    .hero-visual{
      border-radius: 22px; border: 1px solid var(--line); padding: 14px;
      background: linear-gradient(180deg, var(--card), var(--glass));
      box-shadow: var(--shadow-2); min-height: 260px;
    }
    .hero-spark{
      position:absolute; inset:auto -40px -40px auto; width: 260px; height: 260px; border-radius: 50%;
      background: radial-gradient(closest-side, rgba(134,176,255,.15), transparent 70%);
      filter: blur(6px);
    }
    .waves{
      position:absolute; inset:auto 0 0 0; height: 120px; pointer-events:none; opacity:.35;
      background:
        radial-gradient(300px 60px at 20% 40%, var(--brand), transparent 70%),
        radial-gradient(300px 60px at 60% 60%, var(--brand-2), transparent 70%),
        radial-gradient(300px 60px at 90% 30%, var(--brand), transparent 70%);
      filter: blur(35px);
    }
    @media(max-width:980px){ .hero{grid-template-columns:1fr} .hero-visual{min-height:180px} }

    /* ===== Cards / Surfaces ===== */
    .card{
      background: linear-gradient(180deg, var(--card), var(--glass));
      border: 1px solid var(--line);
      border-radius: var(--radius-l);
      padding: 1rem;
      margin:.9rem 0;
      box-shadow: var(--shadow-1);
      animation: fadeIn .35s ease both;
    }
    .card:hover{ box-shadow: var(--shadow-2); transition: box-shadow .2s ease; }

    /* ===== Layout helpers ===== */
    .row{display:flex;gap:.8rem;flex-wrap:wrap}
    .row>*{flex:1;min-width:240px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:.9rem}
    .grid3{display:grid;grid-template-columns:1.2fr 1fr 1fr;gap:.9rem}
    @media(max-width:1100px){.grid3{grid-template-columns:1fr}.grid2{grid-template-columns:1fr}}

    /* ===== Form controls ===== */
    label{display:block;font-size:.9rem;margin:.4rem 0 .25rem;color:var(--muted)}
    input,select,textarea{
      width:100%;padding:.7rem .9rem;border-radius:12px;border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
      color:var(--fg); outline: none; transition: box-shadow .15s ease, border-color .15s ease, transform .05s ease;
    }
    input:focus,select:focus,textarea:focus{
      border-color: var(--focus); box-shadow: var(--ring); transform: translateY(-1px);
    }

    /* ===== Buttons ===== */
    .btn,button{
      appearance:none; cursor:pointer; border-radius:12px; border:1px solid var(--line);
      padding:.65rem .95rem; color:var(--fg); background: linear-gradient(180deg, var(--glass), transparent);
      transition: transform .06s ease, box-shadow .2s ease, background .2s ease, border-color .2s ease;
    }
    .btn:hover,button:hover{ transform: translateY(-1px); box-shadow: var(--shadow-2); }
    .btn:active,button:active{ transform: translateY(0); }
    .primary{
      background: linear-gradient(180deg, var(--brand), calc(100% - 10px), var(--brand-2));
      color: #071228; border-color: transparent; font-weight:600;
    }
    .ghost{ background: transparent }
    .danger{ border-color: rgba(255,0,0,.35); color: var(--bad) }

    /* ===== Chips / Pills / Badges ===== */
    .pill{
      display:inline-flex;align-items:center;gap:.4rem;
      padding:.28rem .6rem;border-radius:999px;background:var(--pill-bg);
      border:1px solid var(--pill-br); color:var(--pill-fg); font-size:.82rem;
    }
    .chip{display:inline-flex;align-items:center;gap:.45rem;padding:.35rem .6rem;border-radius:999px;border:1px solid var(--line);background:var(--glass)}
    .badge{display:inline-block;padding:.25rem .55rem;border-radius:10px;border:1px solid var(--line);font-size:.8rem}
    .badge.ok{background:rgba(0,150,0,.12)} .badge.bad{background:rgba(220,0,0,.12)} .badge.warn{background:rgba(255,170,0,.15)}

    /* ===== Tables ===== */
    table{width:100%;border-collapse:separate;border-spacing:0;margin-top:.6rem;overflow:hidden;border-radius:14px;border:1px solid var(--line)}
    thead th{
      position: sticky; top:0; z-index:1;
      background: var(--table-head); color: var(--fg);
      font-weight:600; text-transform:uppercase; letter-spacing:.03em; font-size:.75rem;
    }
    th,td{padding:.75rem .75rem;border-bottom:1px solid var(--line); text-align:left}
    tbody tr{transition: background .15s ease}
    tbody tr:hover{background: rgba(134,176,255,.08)}
    th[data-sort]{cursor:pointer}
    th[data-sort]::after{content:"‚Üï";margin-left:.4rem;opacity:.6;font-weight:400}

    .toolbar{display:flex;gap:.7rem;align-items:center;justify-content:space-between;margin-bottom:.6rem}
    .table-actions{display:flex;gap:.45rem;flex-wrap:wrap}
    .right{text-align:right}
    .muted{color:var(--muted);font-size:.9rem}
    .hint{font-size:.86rem;color:var(--muted);margin-top:.3rem}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)}

    /* ===== Tiny visualizations ===== */
    .progress{height:10px;background:rgba(255,255,255,.12);border-radius:8px;overflow:hidden}
    .progress>span{display:block;height:100%;background:linear-gradient(90deg,var(--brand),var(--brand-2));width:0}
    .mini-bars{display:flex;gap:4px;align-items:flex-end;height:40px}
    .mini-bars .bar{width:10px;background:linear-gradient(180deg,var(--brand),transparent);border-radius:3px}

    /* ===== Toasts ===== */
    #toastWrap{position:fixed;top:16px;right:16px;display:flex;flex-direction:column;gap:10px;z-index:9999}
    .toast{min-width:280px;max-width:380px;padding:.9rem 1rem;border-radius:14px;border:1px solid var(--line);background:linear-gradient(180deg, var(--card), var(--glass));box-shadow:var(--shadow-2);display:flex;align-items:flex-start;gap:.7rem;transform: translateY(-8px);opacity:0;animation: slideIn .35s ease forwards}
    .toast.ok{border-color:rgba(40,205,65,.35)}
    .toast.warn{border-color:rgba(255,204,0,.45)}
    .toast.bad{border-color:rgba(255,59,48,.45)}
    .toast .t-title{font-weight:700;margin-bottom:.2rem}
    .toast .t-close{margin-left:auto;cursor:pointer;border:none;background:transparent;color:var(--muted);font-size:1rem}

    /* ===== Chat styles ===== */
    .chat-box{display:flex;flex-direction:column;height:340px;border:1px solid var(--line);border-radius:14px;overflow:hidden;background:linear-gradient(180deg,var(--card),var(--glass))}
    .chat-messages{flex:1;overflow:auto;padding:10px}
    .chat-input{display:flex;gap:.5rem;border-top:1px solid var(--line);padding:10px;background:var(--glass)}
    .msg{display:flex;margin:.35rem 0}
    .msg .bubble{padding:.55rem .75rem;border-radius:12px;border:1px solid var(--line);max-width:75%}
    .msg.user{justify-content:flex-end}
    .msg.user .bubble{background:var(--pill-bg)}
    .msg.bot .bubble{background:rgba(255,255,255,.03)}
    .quick{display:inline-flex;gap:.4rem;flex-wrap:wrap;margin-top:.4rem}
    .quick button{font-size:.82rem;padding:.35rem .6rem}

    /* Chat: marcas de tiempo y typing */
    .msg .meta{font-size:.75rem;opacity:.65;margin-top:2px}
    .typing{display:inline-flex;gap:4px;align-items:center}
    .typing i{display:inline-block;width:6px;height:6px;border-radius:50%;opacity:.6;animation:blink 1.1s infinite}
    .typing i:nth-child(2){animation-delay:.15s}
    .typing i:nth-child(3){animation-delay:.3s}
    @keyframes blink{0%,80%,100%{transform:translateY(0);opacity:.25}40%{transform:translateY(-2px);opacity:.9}}

    /* ===== Animations ===== */
    @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
    @keyframes slideIn{to{opacity:1;transform: translateY(0)}}

    /* ===== Utility ===== */
    .fab{
      position: fixed; bottom: 18px; right: 18px; z-index: 40;
      border-radius: 999px; padding:.8rem 1rem; box-shadow: var(--shadow-2);
    }

    /* Accesibilidad */
    :focus-visible { outline: 3px solid var(--focus); outline-offset: 2px; border-radius: 8px; }
    @media (prefers-reduced-motion: reduce) {
      * { animation: none !important; transition: none !important; }
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="brand">
        <div class="brand-logo" aria-hidden="true"></div>
        <h1>KRIS Learning IA ‚Äî v2.4</h1>
      </div>
      <div style="display:flex;gap:.5rem;align-items:center">
        <button id="modeBtn" class="btn ghost" title="Cambiar tema">üåó Tema</button>
      </div>
    </div>
  </header>

  <!-- ====== LANDING HERO (se muestra solo sin sesi√≥n) ====== -->
  <section id="heroView" style="display:none">
    <div class="hero">
      <div class="hero-card" style="min-height: 320px;">
        <div class="hero-spark" aria-hidden="true"></div>
        <span class="pill">Aprendizaje inclusivo + IA</span>
        <h2>Organiza cursos, eval√∫a con r√∫bricas y cuida el bienestar en un solo lugar.</h2>
        <p>Publica actividades, califica con criterios ponderados y detecta se√±ales para acompa√±ar mejor a tus estudiantes.</p>
        <div class="hero-badges">
          <span class="badge">R√∫bricas din√°micas</span>
          <span class="badge">Reportes PDF</span>
          <span class="badge">Plan de apoyo personalizado</span>
          <span class="badge">Chat IA (demo local)</span>
        </div>
        <div class="hero-cta">
          <button id="ctaStart" class="btn primary">Comenzar</button>
          <button id="ctaDemo" class="btn">Usar cuenta demo</button>
        </div>
        <div class="waves" aria-hidden="true"></div>
      </div>
      <div class="hero-visual">
        <div class="card" style="margin:0">
          <h3 style="margin-top:0">Vista previa ¬∑ Dashboard</h3>
          <div class="row">
            <div class="card" style="margin:.4rem 0; flex:1">
              <div class="pill">Promedio</div>
              <div style="font-size:28px;margin-top:6px">86</div>
              <div class="progress" style="margin-top:.4rem"><span style="width:86%"></span></div>
            </div>
            <div class="card" style="margin:.4rem 0; flex:1">
              <div class="pill">A tiempo</div>
              <div style="font-size:28px;margin-top:6px">92%</div>
              <div class="progress" style="margin-top:.4rem"><span style="width:92%"></span></div>
            </div>
          </div>
          <p class="hint">M√°s visualizaciones al iniciar sesi√≥n üëá</p>
        </div>
      </div>
    </div>
  </section>

  <main class="container">
    <!-- LOGIN / REGISTRO -->
    <div id="loginView" class="card">
      <h2 style="margin-top:0">Acceso</h2>
      <p class="muted">Reg√≠strate o inicia sesi√≥n. Los datos viven en <span class="pill">localStorage</span> (demo).</p>
      <div class="row">
        <div>
          <label>Email</label>
          <input id="email" type="email" placeholder="kris@demo"/>
        </div>
        <div>
          <label>Contrase√±a</label>
          <div style="position:relative">
            <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="padding-right:2.2rem"/>
            <button type="button" id="togglePwd" class="btn ghost"
              style="position:absolute;right:4px;top:50%;transform:translateY(-50%);padding:.35rem .55rem">üëÅÔ∏è</button>
          </div>
        </div>
      </div>
      <div class="row">
        <div>
          <label>Nombre</label>
          <input id="displayName" placeholder="Kris"/>
        </div>
        <div>
          <label>Rol</label>
          <select id="role">
            <option value="alumno">Alumno</option>
            <option value="docente">Docente</option>
            <option value="admin">Administrador</option>
          </select>
        </div>
      </div>
      <div style="margin-top:.6rem;display:flex;gap:.5rem;flex-wrap:wrap">
        <button id="loginBtn" class="btn primary">Iniciar sesi√≥n</button>
        <button id="registerBtn" class="btn">Registrar</button>
        <button id="resetBtn" class="btn danger">Limpiar demo</button>
      </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashView" class="card" style="display:none">
      <div class="toolbar">
        <div>Sesi√≥n: <span id="whoAmI" class="pill"></span></div>
        <div class="table-actions">
          <button id="logoutBtn" class="btn">Cerrar sesi√≥n</button>
        </div>
      </div>
      <div id="dashContent"></div>
    </div>
  </main>

  <!-- Toasts -->
  <div id="toastWrap" aria-live="polite" aria-atomic="true"></div>

  <!-- Acci√≥n flotante (atajo a PDF de curso para docentes) -->
  <button id="fab" class="btn primary fab" style="display:none">‚¨áÔ∏è Reporte curso</button>

  <script>
    /* === Tema por preferencia del sistema (primera vez) === */
    const DB_KEYS={
      users:'v2_users', courses:'v2_courses', activities:'v2_activities',
      submissions:'v2_submissions', grades:'v2_grades', session:'v2_session',
      profiles:'v2_profiles', moods:'v2_moods', theme:'v2_theme',
      surveys:'v2_surveys', chat:'v2_chat'
    };
    (function initTheme(){
      const hasPref = !!localStorage.getItem(DB_KEYS.theme);
      if (!hasPref) {
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        localStorage.setItem(DB_KEYS.theme, prefersDark ? 'dark' : 'light');
      }
    })();

    /* ==================== BD local ==================== */
    const db={
      get:k=>JSON.parse(localStorage.getItem(k)||'[]'),
      set:(k,v)=>localStorage.setItem(k,JSON.stringify(v)),
      clear:()=>Object.values(DB_KEYS).forEach(k=>localStorage.removeItem(k))
    };

    function seed(){
      if(!localStorage.getItem(DB_KEYS.users)){
        db.set(DB_KEYS.users,[
          {email:'admin@demo',password:'admin',role:'admin',name:'Admin'},
          {email:'doc@demo',password:'doc',role:'docente',name:'Docente Demo'},
          {email:'kris@demo',password:'alumno',role:'alumno',name:'Kris Demo'}
        ]);
      }
      if(!localStorage.getItem(DB_KEYS.courses)){
        db.set(DB_KEYS.courses,[
          {id:'C-001',nombre:'Programaci√≥n I',horario:'Lun 18-20',docentes:['doc@demo'],alumnos:['kris@demo']},
          {id:'C-002',nombre:'Socioemocional',horario:'Mi√© 19-21',docentes:['doc@demo'],alumnos:['kris@demo']}
        ]);
      }
      if(!localStorage.getItem(DB_KEYS.activities)){
        db.set(DB_KEYS.activities,[
          {id:'A-001',courseId:'C-001',titulo:'Funciones b√°sicas',descripcion:'5 ejercicios',fechaEntrega:'2025-11-20',rubric:[{id:'r1',name:'Exactitud',weight:60},{id:'r2',name:'Claridad',weight:40}]},
          {id:'A-002',courseId:'C-002',titulo:'Diario de emociones',descripcion:'3 entradas',fechaEntrega:'2025-11-22',rubric:[{id:'r1',name:'Reflexi√≥n',weight:70},{id:'r2',name:'Constancia',weight:30}]}
        ]);
      }
      ['submissions','grades','profiles','moods','surveys','chat'].forEach(k=>{
        if(!localStorage.getItem(DB_KEYS[k])) db.set(DB_KEYS[k],[]);
      });
      if(!localStorage.getItem(DB_KEYS.theme)) localStorage.setItem(DB_KEYS.theme,'light');
    }

    /* ==================== Sesi√≥n ==================== */
    function saveSession(user){ localStorage.setItem(DB_KEYS.session,JSON.stringify(user)); }
    function loadSession(){ try{return JSON.parse(localStorage.getItem(DB_KEYS.session))}catch{return null} }
    function clearSession(){ localStorage.removeItem(DB_KEYS.session); }

    /* ==================== Helpers ==================== */
    const el=s=>document.querySelector(s);
    const fmtDate=iso=>iso? new Date(iso+'T00:00:00').toLocaleDateString(): '-';
    const todayISO=()=> new Date().toISOString().slice(0,10);
    const daysLeft=iso=>{
      if(!iso) return '';
      const d=new Date(iso+'T23:59:59');
      const diff=Math.ceil((d-new Date())/86400000);
      return diff>=0? `${diff} d√≠a${diff!==1?'s':''}`:`vencido ${Math.abs(diff)}d`;
    };
    function setProgress(elPct, pct){ elPct.style.width = Math.max(0,Math.min(100,pct)) + '%'; }
    function sparkBars(values){ const max=Math.max(1,...values); return '<div class="mini-bars">'+values.map(v=>'<div class="bar" style="height:'+Math.round((v/max)*100)+'%" title="'+v+'"></div>').join('')+'</div>'; }

    // Toasts
    function showToast(message, {type='ok', title}={}){
      const wrap = el('#toastWrap');
      const t = document.createElement('div');
      t.className = 'toast '+type;
      t.innerHTML = '<div>'+(title? '<div class="t-title">'+title+'</div>':'')+'<div>'+message+'</div></div><button class="t-close" aria-label="Cerrar">√ó</button>';
      t.querySelector('.t-close').onclick = ()=> t.remove();
      wrap.appendChild(t);
      setTimeout(()=>{ t.remove(); },4400);
    }
    const _alert = window.alert; window.alert = (msg)=> showToast(String(msg), {type:'ok'});

    // R√∫brica
    function genComments(rubric, scores){
      if(!rubric?.length || !scores?.length) return '';
      return rubric.map((r,i)=>{
        const s = Number(scores[i]||0);
        const tag = s>=85? 'Excelente': s>=70? 'Bueno': s>=50? 'A mejorar': 'Insuficiente';
        return r.name+': '+tag+' ('+s+'%)';
      }).join(' ¬∑ ');
    }
    function totalFromRubric(rubric, scores){
      if(!rubric?.length || !scores?.length) return null;
      let total = 0, wsum = 0;
      rubric.forEach((r,i)=>{ total += Number(scores[i]||0)*Number(r.weight||0); wsum += Number(r.weight||0); });
      if(wsum<=0) return null;
      return Math.round(total / wsum);
    }
    function addRubricRow(container, name='', weight=''){
      const row = document.createElement('div');
      row.className = 'row';
      row.innerHTML = '<div><input placeholder="Criterio" value="'+name+'"></div><div><input type="number" min="0" max="100" placeholder="Peso%" value="'+weight+'"></div><div style="flex:0 0 auto"><button class="badge warn" data-rm>‚úï</button></div>';
      row.querySelector('[data-rm]').onclick = ()=> row.remove();
      container.appendChild(row);
    }
    function collectRubricFromForm(container){
      const items = [];
      container.querySelectorAll('.row').forEach((r,i)=>{
        const ins = r.querySelectorAll('input');
        const name = (ins[0]?.value||'').trim();
        const weight = parseInt(ins[1]?.value||'0',10);
        if(name && !Number.isNaN(weight)) items.push({id:'r'+(i+1), name, weight});
      });
      return items;
    }

    // Inclusi√≥n / √°nimo
    function getProfile(email){ return db.get(DB_KEYS.profiles).find(p=>p.email===email); }
    function setProfile(p){
      const arr=db.get(DB_KEYS.profiles);
      const i=arr.findIndex(x=>x.email===p.email);
      if(i>=0) arr[i]=p; else arr.push(p);
      db.set(DB_KEYS.profiles,arr);
    }
    function buildPlan(needs){
      const plan={hints:[],strategies:[],mode:{}};
      if(needs.includes('ansiedad')){ plan.hints.push('Tareas breves, pausas 5-2-5'); plan.mode.focus='sesiones cortas'; plan.strategies.push('Apertura/cierre relajante'); }
      if(needs.includes('TDAH')){ plan.hints.push('Retos + recompensas'); plan.mode.gamify=true; plan.strategies.push('Checklist visual'); }
      if(needs.includes('depresion')){ plan.hints.push('Metas micro + refuerzo'); plan.strategies.push('Mensajes emp√°ticos'); }
      if(needs.includes('autismo')){ plan.hints.push('Instrucciones paso a paso'); plan.strategies.push('Predecibilidad / baja estimulaci√≥n'); }
      return plan;
    }
    function logMood(email,mood,text=''){
      const m=db.get(DB_KEYS.moods);
      m.push({email,mood,text,ts:new Date().toISOString()});
      db.set(DB_KEYS.moods,m);
    }

    /* ==================== Chat helpers persistencia / formato ==================== */
    function saveChatMsg(email, role, text){
      const arr=db.get(DB_KEYS.chat);
      arr.push({email, role, text, ts:new Date().toISOString()});
      db.set(DB_KEYS.chat, arr);
    }
    function loadChatMsgs(email, limit=120){
      return db.get(DB_KEYS.chat).filter(m=>m.email===email).slice(-limit);
    }
    function clearChatMsgs(email){
      const rest=db.get(DB_KEYS.chat).filter(m=>m.email!==email);
      db.set(DB_KEYS.chat, rest);
    }
    function downloadJSONFile(name, obj){
      const a=document.createElement('a');
      a.href=URL.createObjectURL(new Blob([JSON.stringify(obj,null,2)],{type:'application/json'}));
      a.download=name; a.click(); URL.revokeObjectURL(a.href);
    }
    function linkify(text){
      const urlRe=/((https?:\/\/|www\.)[^\s<]+)/gi;
      return text.replace(urlRe, m=>{
        const href = m.startsWith('http')? m : 'http://'+m;
        return '<a href="'+href+'" target="_blank" rel="noopener">'+m+'</a>';
      });
    }
    // Markdown ultra-ligero
    function md(text){
      let t = text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      t = t.replace(/\*\*(.+?)\*\*/g,'<b>$1</b>')
           .replace(/\*(.+?)\*/g,'<i>$1</i>')
           /* ‚úÖ regex corregida (par√©ntesis balanceados) */
           .replace(/\[(.+?)\]\((https?:\/\/[^\s)]+)\)/g,'$1'); /* seguriza links raros */
      if (/^\s*-\s+/m.test(t)){
        t = '<ul>'+t.split('\n').map(l=>/^\s*-\s+/.test(l)? '<li>'+l.replace(/^\s*-\s+/,'')+'</li>' : l).join('\n')+'</ul>';
      } else {
        t = t.replace(/\n/g,'<br>');
      }
      return linkify(t);
    }

    /* ==================== Encuesta diagn√≥stica ==================== */
    const SURVEY_QUESTIONS=[
      {id:'q1',  txt:'Me cuesta mantener la atenci√≥n en tareas o clases durante m√°s de 15 minutos.', type:'likert', map:'TDAH'},
      {id:'q2',  txt:'Siento preocupaci√≥n o ansiedad con frecuencia que afecta mi estudio.', type:'likert', map:'ansiedad'},
      {id:'q3',  txt:'Pierdo plazos o me desorganizo con facilidad.', type:'likert', map:'TDAH'},
      {id:'q4',  txt:'Me siento triste o con muy poca energ√≠a varios d√≠as a la semana.', type:'likert', map:'depresion'},
      {id:'q5',  txt:'Prefiero instrucciones muy claras y paso a paso.', type:'likert', map:'autismo'},
      {id:'q6',  txt:'Me molestan ruidos fuertes o ambientes con mucha gente.', type:'likert', map:'autismo'},
      {id:'q7',  txt:'Antes de una entrega importante me cuesta dormir o concentrarme.', type:'likert', map:'ansiedad'},
      {id:'q8',  txt:'Me ayuda dividir los trabajos en subtareas peque√±as.', type:'likert', map:'TDAH'},
      {id:'q9',  txt:'He perdido inter√©s en actividades que antes disfrutaba.', type:'likert', map:'depresion'},
      {id:'q10', txt:'¬øTe gustar√≠a apoyo adicional del docente?', type:'yn',    map:'ansiedad'},
      {id:'q11', txt:'¬øNecesitas m√°s tiempo en evaluaciones?',  type:'yn',    map:'TDAH'},
      {id:'q12', txt:'Cu√©ntame algo que quieras que sepa tu docente (opcional).', type:'text', map:''}
    ];
    function renderSurveyHTML(prev={}){
      const likert = (name, val)=> {
        let html = '';
        for(let i=1;i<=5;i++){
          const checked = String(val||'')===String(i)? 'checked':'';
          html += '<label class="chip"><input type="radio" name="'+name+'" value="'+i+'" '+checked+'> '+i+'</label>';
        }
        return html;
      };
      return '<div class="card">'
        +'<h3 style="margin-top:0">Autoevaluaci√≥n (confidencial)</h3>'
        +'<p class="muted">1 = en desacuerdo ¬∑ 5 = muy de acuerdo.</p>'
        + SURVEY_QUESTIONS.map(q=>{
            const saved = prev[q.id] || '';
            if(q.type==='likert'){
              return '<div style="margin:.5rem 0"><label>'+q.txt+'</label><div class="quick">'+likert(q.id, saved)+'</div></div>';
            }
            if(q.type==='yn'){
              return '<div class="row"><div><label>'+q.txt+'</label><select id="'+q.id+'"><option value="">Selecciona‚Ä¶</option><option value="si" '+(saved==='si'?'selected':'')+'>S√≠</option><option value="no" '+(saved==='no'?'selected':'')+'>No</option></select></div></div>';
            }
            return '<div class="row"><div><label>'+q.txt+'</label><textarea id="'+q.id+'" rows="2" placeholder="Opcional">'+(saved||'')+'</textarea></div></div>';
          }).join('')
        +'<div class="table-actions" style="margin-top:.6rem">'
          +'<button id="saveSurvey" class="btn primary">Guardar encuesta</button>'
          +'<button id="clearSurvey" class="btn">Limpiar</button>'
        +'</div>'
      +'</div>';
    }
    function scoreRiskFromSurvey(ans){
      const acc={ansiedad:0,TDAH:0,depresion:0,autismo:0};
      SURVEY_QUESTIONS.forEach(q=>{
        const v = ans[q.id];
        if(q.type==='likert' && q.map && v){ acc[q.map] += Number(v||0); }
        else if(q.type==='yn' && q.map){ acc[q.map] += (v==='si')? 2 : 0; }
      });
      const needs=[];
      if(acc.ansiedad>=7) needs.push('ansiedad');
      if(acc.TDAH>=7) needs.push('TDAH');
      if(acc.depresion>=7) needs.push('depresion');
      if(acc.autismo>=7) needs.push('autismo');
      return {scores:acc, needs};
    }
    function latestSurveyByEmail(email){
      const all = db.get(DB_KEYS.surveys);
      const list = all.filter(s=>s.email===email);
      if(!list.length) return null;
      return [...list].sort((a,b)=> String(b.ts).localeCompare(String(a.ts)))[0];
    }

    /* ==================== M√©tricas curso / global ==================== */
    function isOnTime(sub, act){
      if(!act?.fechaEntrega) return true;
      const due = new Date(act.fechaEntrega+'T23:59:59');
      return new Date(sub.fecha).getTime() <= due.getTime();
    }
    function gradeStatsForCourse(courseId){
      const courses = db.get(DB_KEYS.courses);
      const acts = db.get(DB_KEYS.activities).filter(a=>a.courseId===courseId);
      const subs = db.get(DB_KEYS.submissions).filter(s=> acts.some(a=>a.id===s.activityId));
      const grades = db.get(DB_KEYS.grades);
      const alumnos = new Set((courses.find(c=>c.id===courseId)?.alumnos)||[]);
      const gradedScores = subs.map(s=> grades.find(g=>g.submissionId===s.id)).filter(Boolean).map(g=>g.score);
      const avg = gradedScores.length? Math.round(gradedScores.reduce((a,b)=>a+b,0)/gradedScores.length) : null;
      const gradedIds = new Set(grades.map(g=>g.submissionId));
      const pending = subs.filter(s=> !gradedIds.has(s.id)).length;
      const ontime = subs.filter(s=> isOnTime(s, acts.find(a=>a.id===s.activityId))).length;
      const ontimePct = subs.length? Math.round(ontime*100/subs.length):0;
      return {avg, pending, ontimePct, subsCount:subs.length, alumnos:alumnos.size};
    }
    function courseReportHTML(courseId){
      const acts = db.get(DB_KEYS.activities).filter(a=>a.courseId===courseId);
      const subs = db.get(DB_KEYS.submissions).filter(s=> acts.some(a=>a.id===s.activityId));
      const grades = db.get(DB_KEYS.grades);
      const graded = subs.map(s=> grades.find(g=>g.submissionId===s.id)).filter(Boolean).map(g=>g.score);
      const avg = graded.length? Math.round(graded.reduce((a,b)=>a+b,0)/graded.length) : null;
      const gradedIds = new Set(grades.map(g=>g.submissionId));
      const pending = subs.filter(s=> !gradedIds.has(s.id)).length;
      const ontime = subs.filter(s=> isOnTime(s, acts.find(a=>a.id===s.activityId))).length;
      const ontimePct = subs.length? Math.round((ontime/subs.length)*100): 0;

      const distBins=[{r:'0-59',min:0,max:59,c:0},{r:'60-69',min:60,max:69,c:0},{r:'70-79',min:70,max:79,c:0},{r:'80-89',min:80,max:89,c:0},{r:'90-100',min:90,max:100,c:0}];
      graded.forEach(sc=>{ const b = distBins.find(d=> sc>=d.min && sc<=d.max); if(b) b.c++; });

      const pendingBy = {};
      subs.forEach(s=>{ if(!gradedIds.has(s.id)) pendingBy[s.alumno]=(pendingBy[s.alumno]||0)+1; });
      const topPending = Object.entries(pendingBy).sort((a,b)=>b[1]-a[1]).slice(0,5);

      return ''+
        '<div class="grid2">'+
          '<div class="card">'+
            '<h3>Resumen</h3>'+
            '<div class="kpi"><span class="pill">Actividades</span> <b>'+acts.length+'</b></div>'+
            '<div class="kpi"><span class="pill">Entregas</span> <b>'+subs.length+'</b> ¬∑ Pendientes: <b>'+pending+'</b></div>'+
            '<div class="kpi"><span class="pill">Promedio</span> <b>'+(avg ?? '‚Äî')+'</b></div>'+
            '<div class="kpi"><span class="pill">% a tiempo</span> <b>'+ontimePct+'%</b></div>'+
            '<div class="hint" style="margin-top:.6rem">Distribuci√≥n: '+sparkBars(distBins.map(d=>d.c))+
            '<div class="muted" style="margin-top:.2rem">'+distBins.map(d=>d.r+': '+d.c).join(' ¬∑ ')+'</div></div>'+
          '</div>'+
          '<div class="card">'+
            '<h3>Pendientes por alumno (Top 5)</h3>'+
            (topPending.length? '<table><thead><tr><th>Alumno</th><th>Pendientes</th></tr></thead><tbody>'+topPending.map(function(pair){return '<tr><td>'+pair[0]+'</td><td>'+pair[1]+'</td></tr>';}).join('')+'</tbody></table>' : '<p class="muted">Sin pendientes üéâ</p>')+
          '</div>'+
        '</div>';
    }

    /* ============ ‚ÄúPDF‚Äù imprimible por curso ============ */
    function openCoursePDF(courseId){
      const courses = db.get(DB_KEYS.courses);
      const course  = courses.find(c => c.id === courseId);
      const stats   = gradeStatsForCourse(courseId);
      const now     = new Date().toLocaleString();

      const docHTML = '<!DOCTYPE html>'
      + '<html><head><meta charset="utf-8"><title>Reporte '+(courseId)+'</title>'
      + '<style>body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;color:#111;margin:0;padding:24px;background:#fff}'
        + 'h1,h2,h3{margin:.2em 0}.muted{color:#666}.kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin:16px 0}'
        + '.kpi{border:1px solid #e4e6eb;border-radius:10px;padding:12px}'
        + 'table{width:100%;border-collapse:collapse;margin-top:12px;font-size:14px}'
        + 'th,td{border:1px solid #e4e6eb;padding:8px;text-align:left}th{background:#f6f7f9}'
        + '.note{font-size:12px;color:#666;margin-top:10px}@media print{@page{margin:16mm}}</style>'
      + '</head><body>'
      + '<h1>Reporte del curso: '+(course?.id || courseId)+' ‚Äî '+(course?.nombre||'')+'</h1>'
      + '<div class="muted">Generado: '+now+'</div>'
      + '<div class="kpis">'
        + '<div class="kpi"><b>Promedio</b><div style="font-size:28px;margin-top:6px">'+(stats.avg??'‚Äî')+'</div></div>'
        + '<div class="kpi"><b>Pendientes</b><div style="font-size:28px;margin-top:6px">'+stats.pending+'</div></div>'
        + '<div class="kpi"><b>% a tiempo</b><div style="font-size:28px;margin-top:6px)">'+stats.ontimePct+'%</div></div>'
      + '</div>'
      + '<h2>Detalle</h2>'
      + courseReportHTML(courseId)
      + '<div class="note">Consejo: en el di√°logo de impresi√≥n, elige ‚ÄúGuardar como PDF‚Äù.</div>'
      + '<script>setTimeout(function(){window.print()},300);<\/script>'
      + '</body></html>';

      const w = window.open('about:blank','_blank');
      if (!w) {
        showToast('Permite las ventanas emergentes para ver el PDF.', {type:'warn'});
        return;
      }
      w.document.open();
      w.document.write(docHTML);
      w.document.close();
      w.onload = () => { try { w.print(); } catch (e) {} };
    }

    /* ==================== Auth ==================== */
    function register(){
      const email=el('#email').value.trim();
      const password=el('#password').value.trim();
      const role=el('#role').value;
      const name=(el('#displayName').value.trim()||email);
      if(!email||!password) return alert('Email y contrase√±a obligatorios.');
      const users=db.get(DB_KEYS.users);
      if(users.find(u=>u.email===email)) return alert('Ese email ya existe.');
      users.push({email,password,role,name});
      db.set(DB_KEYS.users,users);
      alert('Cuenta creada. Ahora inicia sesi√≥n.');
    }
    function login(){
      const email=el('#email').value.trim();
      const password=el('#password').value.trim();
      const users=db.get(DB_KEYS.users);
      const user=users.find(u=>u.email===email && u.password===password);
      if(!user) return alert('Credenciales inv√°lidas.');
      saveSession(user); render();
    }

    /* ==================== Render principal ==================== */
    function render(){
      seed();
      const theme=localStorage.getItem(DB_KEYS.theme)||'light';
      document.documentElement.setAttribute('data-theme',theme);
      el('#modeBtn').textContent= theme==='light'? 'üåô Oscuro':'‚òÄÔ∏è Claro';

      const session=loadSession();
      const fab=el('#fab');
      const hero=el('#heroView');

      if(!session){
        hero.style.display='';
        el('#loginView').style.display='';
        el('#dashView').style.display='none';
        fab.style.display='none';
        return;
      }
      hero.style.display='none';
      el('#loginView').style.display='none';
      el('#dashView').style.display='';
      el('#whoAmI').textContent=session.name+' ¬∑ '+session.role+' ¬∑ '+session.email;
      fab.style.display = session.role==='docente' ? '' : 'none';
      renderDash(session);
    }
    function renderDash(session){
      const root=el('#dashContent'); root.innerHTML='';
      if(session.role==='admin') return renderAdmin(root,session);
      if(session.role==='docente') return renderDocente(root,session);
      return renderAlumno(root,session);
    }

    /* ==================== ADMIN ==================== */
    function renderAdmin(root){
      const users   = db.get(DB_KEYS.users) || [];
      const courses = db.get(DB_KEYS.courses) || [];

      // Precalcular filas del ranking
      const rows = courses.map(c=>{
        const s = gradeStatsForCourse(c.id);
        const avg = (s && typeof s.avg === 'number') ? s.avg : 0;
        return {
          id: c.id,
          nombre: c.nombre,
          avg: avg,
          pending: s ? s.pending : 0,
          ontime: s ? s.ontimePct : 0,
          alumnos: s ? s.alumnos : 0
        };
      });

     root.innerHTML =
  '<h2>Administrador</h2>'+
  '<div class="card">'+
    '<h3>Dashboard global</h3>'+
    '<p class="muted">Ranking de cursos por promedio, pendientes y puntualidad.</p>'+
    '<div class="toolbar">'+
      '<div class="table-actions">'+
        '<button data-rank="avg" class="btn primary">Promedio</button>'+
        '<button data-rank="pending" class="btn">Pendientes</button>'+
        '<button data-rank="ontime" class="btn">Puntualidad</button>'+
      '</div>'+
      '<input id="admin_filter" placeholder="Filtrar cursos..." />'+
    '</div>'+
    '<table id="admin_table"><thead><tr>'+
      '<th data-s="id">ID</th><th data-s="nombre">Nombre</th>'+
      '<th data-s="avg">Promedio</th><th data-s="pending">Pendientes</th>'+
      '<th data-s="ontime">% a tiempo</th><th data-s="alumnos">Alumnos</th>'+
    '</tr></thead><tbody>'+
      rows.map(function(r){
        return ''+
        '<tr>'+
          '<td>'+r.id+'</td>'+
          '<td>'+r.nombre+'</td>'+
          '<td>'+r.avg+' '+sparkBars([r.avg, Math.max(0, 100 - r.avg)])+'</td>'+
          '<td>'+r.pending+'</td>'+
          '<td>'+r.ontime+'%</td>'+
          '<td>'+r.alumnos+'</td>'+
        '</tr>';
      }).join('')+
    '</tbody></table>'+
  '</div>'+
  '<div class="grid3">'+
    '<div class="card">'+
      '<h3>Crear curso</h3>'+
      '<div class="row">'+
        '<div><label>ID</label><input id="c_id" placeholder="C-003"></div>'+
        '<div><label>Nombre</label><input id="c_nombre" placeholder="Matem√°ticas I"></div>'+
        '<div><label>Horario</label><input id="c_horario" placeholder="Vie 18-20"></div>'+
      '</div>'+
      '<div class="row">'+
        '<div><label>Docentes</label><select id="c_docentes" multiple>'+
          users.filter(function(u){return u.role==='docente';})
               .map(function(u){return '<option value="'+u.email+'">'+u.name+' ('+u.email+')</option>';}).join('')+
        '</select></div>'+
        '<div><label>Alumnos</label><select id="c_alumnos" multiple>'+
          users.filter(function(u){return u.role==='alumno';})
               .map(function(u){return '<option value="'+u.email+'">'+u.name+' ('+u.email+')</option>';}).join('')+
        '</select></div>'+
      '</div>'+
      '<div style="margin-top:.6rem"><button id="btnCrearCurso" class="btn primary">Crear curso</button></div>'+
    '</div>'+
    '<div class="card" style="grid-column: span 2;">'+
      '<div class="toolbar"><h3 style="margin:0">Cursos</h3><input id="c_filter" placeholder="Filtrar..."/></div>'+
      '<table id="c_table"><thead><tr>'+
        '<th data-sort="id">ID</th><th data-sort="nombre">Nombre</th><th>Horario</th><th>Docentes</th><th>Alumnos</th><th class="right">Acciones</th>'+
      '</tr></thead><tbody>'+
        courses.map(function(c){
          return '<tr>'+
            '<td>'+c.id+'</td>'+
            '<td>'+c.nombre+'</td>'+
            '<td>'+c.horario+'</td>'+
            '<td>'+((c.docentes||[]).join(', '))+'</td>'+
            '<td>'+((c.alumnos||[]).join(', '))+'</td>'+
            '<td class="right"><button data-del-course="'+c.id+'" class="btn">Eliminar</button></td>'+
          '</tr>';
        }).join('')+
      '</tbody></table>'+
      '<div id="c_pagination"></div>'+
    '</div>'+
  '</div>';

// ------- Helpers de interacci√≥n -------
function rerenderRank(by){
  const tbody = el('#admin_table tbody');
  if(!tbody) return;
  const sorted = rows.slice().sort(function(a,b){
    if(by==='avg' || by==='ontime') return (b[by]||0) - (a[by]||0);
    if(by==='pending') return (b.pending||0) - (a.pending||0);
    return String(a.nombre||'').localeCompare(String(b.nombre||''));
  });
  tbody.innerHTML = sorted.map(function(r){
    return ''+
    '<tr>'+
      '<td>'+r.id+'</td>'+
      '<td>'+r.nombre+'</td>'+
      '<td>'+r.avg+' '+sparkBars([r.avg, Math.max(0, 100 - r.avg)])+'</td>'+
      '<td>'+r.pending+'</td>'+
      '<td>'+r.ontime+'%</td>'+
      '<td>'+r.alumnos+'</td>'+
    '</tr>';
  }).join('');
}

// Botones de ranking (compatibles con NodeList sin .forEach)
(function(){
  var nlist = document.querySelectorAll('[data-rank]');
  var rankBtns = Array.prototype.slice.call(nlist || []);
  rankBtns.forEach(function(b){
    b.onclick = function(){
      var by = b.getAttribute('data-rank');
      rerenderRank(by);
    };
  });
})

      // Filtro r√°pido de la tabla de ranking
      attachFilter('#admin_filter', '#admin_table');

      // ------- CRUD Cursos -------
      const btnCrear = el('#btnCrearCurso');
      if (btnCrear){
        btnCrear.onclick = function(){
          const id       = (el('#c_id')||{}).value ? el('#c_id').value.trim() : '';
          const nombre   = (el('#c_nombre')||{}).value ? el('#c_nombre').value.trim() : '';
          const horario  = (el('#c_horario')||{}).value ? el('#c_horario').value.trim() : '';
          const docentes = (el('#c_docentes') && el('#c_docentes').selectedOptions) ? Array.from(el('#c_docentes').selectedOptions).map(function(o){return o.value;}) : [];
          const alumnos  = (el('#c_alumnos') && el('#c_alumnos').selectedOptions) ? Array.from(el('#c_alumnos').selectedOptions).map(function(o){return o.value;}) : [];
          if(!id || !nombre){ showToast('Faltan campos', {type:'bad'}); return; }

          const list = db.get(DB_KEYS.courses) || [];
          if(list.some(function(x){return x.id===id;})){ showToast('ID existente', {type:'warn'}); return; }
          list.push({id:id, nombre:nombre, horario:horario, docentes:docentes, alumnos:alumnos});
          db.set(DB_KEYS.courses, list);
          showToast('Curso creado',{type:'ok'});
          render();
        };
      }

      // Botones eliminar curso
      (root.querySelectorAll('button[data-del-course]')||[]).forEach(function(b){
        b.onclick = function(){
          const id = b.getAttribute('data-del-course');
          if(!confirm('¬øEliminar el curso '+id+'? Esta acci√≥n no se puede deshacer.')) return;
          const list = (db.get(DB_KEYS.courses) || []).filter(function(c){ return c.id !== id; });
          db.set(DB_KEYS.courses, list);
          showToast('Curso eliminado',{type:'warn'});
          render();
        };
      });

      // Filtro de la tabla de cursos
      attachFilter('#c_filter','#c_table');

      // Orden simple por encabezado (ID / nombre)
      (root.querySelectorAll('#c_table thead th[data-sort]')||[]).forEach(function(th){
        th.onclick = function(){
          const key = th.getAttribute('data-sort');
          const list = (db.get(DB_KEYS.courses) || []).slice().sort(function(a,b){
            return String(a[key]||'').localeCompare(String(b[key]||''));
          });
          const tbody = el('#c_table tbody');
          if(!tbody) return;
          tbody.innerHTML = list.map(function(c){
            return '<tr><td>'+c.id+'</td><td>'+c.nombre+'</td><td>'+c.horario+'</td><td>'+(c.docentes||[]).join(', ')+'</td><td>'+(c.alumnos||[]).join(', ')+'</td><td class="right"><button data-del-course="'+c.id+'" class="btn">Eliminar</button></td></tr>';
          }).join('');

          // Reasignar handlers de eliminar tras reordenar
          (tbody.querySelectorAll('button[data-del-course]')||[]).forEach(function(b){
            b.onclick = function(){
              const id = b.getAttribute('data-del-course');
              if(!confirm('¬øEliminar el curso '+id+'? Esta acci√≥n no se puede deshacer.')) return;
              const list = (db.get(DB_KEYS.courses) || []).filter(function(c){ return c.id !== id; });
              db.set(DB_KEYS.courses, list);
              showToast('Curso eliminado',{type:'warn'});
              render();
            };
          });
        };
      });

      // Paginaci√≥n de la tabla de cursos
      const rowsDOM = Array.prototype.slice.call(root.querySelectorAll('#c_table tbody tr'));
      const pg = paginate('courses', rowsDOM, 6);
      rowsDOM.forEach(function(tr){ tr.style.display = pg.slice.indexOf(tr) >= 0 ? '' : 'none'; });
      renderPagination('#c_pagination','courses', pg.total);
    }

    /* ==================== DOCENTE ==================== */
    function renderDocente(root,session){
      const courses=db.get(DB_KEYS.courses).filter(c=>(c.docentes||[]).includes(session.email));
      const acts=db.get(DB_KEYS.activities);
      const profiles=db.get(DB_KEYS.profiles);
      const moods=db.get(DB_KEYS.moods);

      const alumnos=[...new Set(courses.flatMap(c=>c.alumnos||[]))];
      const riesgo=profiles.filter(p=>{
        const lm=[...moods].reverse().find(m=>m.email===p.email);
        return lm && /üòü|üòî/.test(lm.mood);
      }).length;
      const last7 = Array.from({length:7},function(_,i){
        const d=new Date(); d.setDate(d.getDate()-(6-i));
        const key=d.toISOString().slice(0,10);
        return moods.filter(m=>m.ts.slice(0,10)===key && /üòü|üòî/.test(m.mood)).length;
      });

      root.innerHTML=
        '<h2>Docente</h2>'+
        '<div class="grid2">'+
          '<div class="card">'+
            '<h3>Panel inclusivo</h3>'+
            '<div class="kpi"><span class="pill">Alumnos</span> <b>'+alumnos.length+'</b></div>'+
            '<div class="kpi"><span class="pill">Perfiles</span> <b>'+profiles.length+'</b></div>'+
            '<div class="kpi"><span class="pill">Alertas 7d</span> <b>'+riesgo+'</b></div>'+
            '<div class="hint" style="margin-top:.6rem">Tendencia 7 d√≠as (alertas): '+sparkBars(last7)+'</div>'+
            '<div style="margin-top:.6rem"><button id="exportCSV" class="btn">Exportar calificaciones CSV</button></div>'+
          '</div>'+
          '<div class="card">'+
            '<h3>Crear / Editar actividad</h3>'+
            '<div class="row">'+
              '<div><label>Curso</label><select id="a_course">'+courses.map(c=>'<option value="'+c.id+'">'+c.id+' ¬∑ '+c.nombre+'</option>').join('')+'</select></div>'+
              '<div><label>T√≠tulo</label><input id="a_title" placeholder="TP1"></div>'+
              '<div><label>Entrega</label><input id="a_due" type="date" value="'+todayISO()+'"></div>'+
            '</div>'+
            '<label>Descripci√≥n</label>'+
            '<textarea id="a_desc" rows="3" placeholder="Instrucciones..."></textarea>'+
            '<label>R√∫brica (din√°mica)</label>'+
            '<div id="rubricBox"></div>'+
            '<div class="table-actions" style="margin-top:.4rem">'+
              '<button id="addCrit" class="btn">+ Criterio</button>'+
              '<button id="btnSaveAct" class="btn primary">Guardar</button>'+
              '<button id="btnClearAct" class="btn">Limpiar</button>'+
            '</div>'+
            '<input type="hidden" id="a_editing" value=""/>'+
          '</div>'+
        '</div>'+
        '<div class="card">'+
          '<div class="toolbar"><h3 style="margin:0">Actividades publicadas</h3><input id="a_filter" placeholder="Filtrar..."/></div>'+
          '<table id="a_table"><thead><tr>'+
            '<th data-sort="id">ID</th><th data-sort="courseId">Curso</th><th data-sort="titulo">T√≠tulo</th><th data-sort="fechaEntrega">Entrega</th><th class="right">Acciones</th>'+
          '</tr></thead><tbody>'+
            acts.map(a=>'<tr>'+
              '<td>'+a.id+'</td><td>'+a.courseId+'</td><td>'+a.titulo+'</td>'+
              '<td>'+fmtDate(a.fechaEntrega)+' '+(a.fechaEntrega?'<span class="pill">'+daysLeft(a.fechaEntrega)+'</span>':'')+'</td>'+
              '<td class="right table-actions"><button data-edit-act="'+a.id+'" class="btn">Editar</button><button data-del-act="'+a.id+'" class="btn">Eliminar</button></td>'+
            '</tr>').join('')+
          '</tbody></table>'+
          '<div id="a_pagination"></div>'+
        '</div>'+
        '<div class="card">'+
          '<div class="toolbar">'+
            '<h3 style="margin:0">Reporte por curso</h3>'+
            '<div class="table-actions">'+
              '<label class="muted" for="rep_course">Curso</label>'+
              '<select id="rep_course" style="min-width:220px">'+
                courses.map(c=>'<option value="'+c.id+'">'+c.id+' ¬∑ '+c.nombre+'</option>').join('')+
              '</select>'+
              '<button id="rep_pdf" class="btn primary">Descargar PDF</button>'+
            '</div>'+
          '</div>'+
          '<div id="reportBox" class="hint"></div>'+
        '</div>'+
        '<div class="card">'+
          '<div class="toolbar"><h3 style="margin:0">Entregas (con r√∫brica)</h3><span class="hint">Introduce puntuaci√≥n por criterio y se calcula el total</span></div>'+
          renderSubmissionsTableForDocente()+
        '</div>';

    /* === NUEVO: resultados de encuesta confidenciales para el docente === */
(function(){
  // Evita colisi√≥n de nombre con otras "rows"
  const surveyRows = alumnos.map(function(mail){
    const s    = latestSurveyByEmail(mail);
    const prof = getProfile(mail) || {};
    const needs = Array.isArray(prof.needs) ? prof.needs : [];
    const when  = s ? new Date(s.ts).toLocaleString() : '‚Äî';
    return { mail: mail, needs: needs, when: when, has: !!s, plan: prof.plan || null };
  }).filter(function(r){ return r.has; });

  const html = ''
    + '<div class="card">'
    +   '<h3>Resultados de encuesta (confidencial)</h3>'
    +   (surveyRows.length
          ? ('<table><thead><tr>'
             + '<th>Alumno</th><th>Etiquetas derivadas</th><th>√öltima encuesta</th><th class="right">Acci√≥n</th>'
             + '</tr></thead><tbody>'
             + surveyRows.map(function(r){
                 var tags = r.needs.length
                   ? r.needs.map(function(n){ return '<span class="badge">'+n+'</span>'; }).join(' ')
                   : '<span class="muted">‚Äî</span>';
                 return ''
                   + '<tr>'
                   +   '<td>'+r.mail+'</td>'
                   +   '<td>'+tags+'</td>'
                   +   '<td>'+r.when+'</td>'
                   +   '<td class="right"><button class="btn" data-view-plan="'+r.mail+'">Ver plan</button></td>'
                   + '</tr>';
               }).join('')
             + '</tbody></table>')
          : '<p class="muted">A√∫n no hay encuestas respondidas por tus alumnos.</p>')
    + '</div>';

  root.insertAdjacentHTML('beforeend', html);

  // Versi√≥n segura de renderPlan (sin optional chaining)
  function renderPlanSafe(plan){
    plan = plan || {};
    var hints = Array.isArray(plan.hints) ? plan.hints : [];
    var strategies = Array.isArray(plan.strategies) ? plan.strategies : [];
    var mode = plan.mode || {};
    var modeTxt = (mode.gamify ? 'Gamificado' : '') + (mode.focus ? (' ' + mode.focus) : '');
    return '<div>'
      + '<div class="pill">Modo: ' + (modeTxt || '‚Äî') + '</div>'
      + '<ul class="hint">' + hints.map(function(h){ return '<li>‚Ä¢ '+h+'</li>'; }).join('') + '</ul>'
      + '<p class="muted">Estrategias: ' + (strategies.length ? strategies.join(' ¬∑ ') : '‚Äî') + '</p>'
      + '</div>';
  }

  // Abrir plan (popup si se puede; si no, inline debajo de la fila)
  Array.prototype.slice.call(root.querySelectorAll('button[data-view-plan]') || []).forEach(function(b){
    b.onclick = function(){
      var mail = b.getAttribute('data-view-plan');
      var prof = getProfile(mail) || {};
      var plan = prof.plan || null;

      if (!plan){
        showToast('Sin plan disponible (a√∫n).', {type:'warn'});
        return;
      }

      // 1) Intento con ventana nueva
      var w;
      try { w = window.open('', '_blank', 'noopener,noreferrer'); } catch (e) { w = null; }

      if (w && w.document){
        w.document.open();
        w.document.write(
          '<!DOCTYPE html><html><head><meta charset="utf-8"><title>Plan de apoyo ‚Äî '+mail+'</title>'
          + '<style>body{font:14px system-ui,Segoe UI,Roboto,Arial,sans-serif;padding:20px;color:#111}'
          + '.muted{color:#666}</style></head><body>'
          + '<h2>Plan de apoyo ‚Äî '+mail+'</h2>'
          + renderPlanSafe(plan)
          + '<p class="muted">Confidencial ¬∑ Uso docente</p>'
          + '</body></html>'
        );
        w.document.close();
        return;
      }

      // 2) Fallback inline: inserta/alternar una fila expansible debajo
      var tr = b.closest('tr');
      if (!tr) { showToast('No se pudo mostrar el plan.',{type:'bad'}); return; }

      var next = tr.nextElementSibling;
      if (next && next.getAttribute && next.getAttribute('data-plan-for') === mail) {
        // Si ya est√° abierto, lo contraemos
        next.parentNode.removeChild(next);
        return;
      }
      // Si hab√≠a otra expansi√≥n de otro alumno, la cerramos
      Array.prototype.slice.call(tr.parentNode.querySelectorAll('tr[data-plan-for]') || [])
        .forEach(function(x){ x.parentNode.removeChild(x); });

      var exp = document.createElement('tr');
      exp.setAttribute('data-plan-for', mail);
      exp.innerHTML = '<td colspan="4"><div class="card" style="margin:.6rem 0">'
        + '<h4 style="margin:.2rem 0">Plan de apoyo ‚Äî '+mail+'</h4>'
        + renderPlanSafe(plan)
        + '</div></td>';
      tr.parentNode.insertBefore(exp, tr.nextSibling);
      showToast('Mostrando plan debajo de la fila',{type:'ok'});
    };
  });
})();


      // R√∫brica default
      const rb = el('#rubricBox'); addRubricRow(rb,'Criterio 1','60'); addRubricRow(rb,'Criterio 2','40');
      el('#addCrit').onclick = ()=> addRubricRow(rb);

      attachFilter('#a_filter','#a_table');
      root.querySelectorAll('#a_table thead th[data-sort]').forEach(th=>{
        th.onclick=()=>{ const key=th.getAttribute('data-sort'); sortRows('acts',db.get(DB_KEYS.activities),key); render(); };
      });
      const rows=[...root.querySelectorAll('#a_table tbody tr')];
      const {slice,total}=paginate('acts',rows,6);
      rows.forEach(tr=> tr.style.display= slice.includes(tr)? '':'none');
      renderPagination('#a_pagination','acts', total);

      el('#btnSaveAct').onclick=()=>{
        const idEditing=el('#a_editing').value;
        const courseId=el('#a_course').value;
        const titulo=el('#a_title').value.trim();
        const descripcion=el('#a_desc').value.trim();
        const fechaEntrega=el('#a_due').value||null;
        if(!titulo) return showToast('Falta t√≠tulo',{type:'bad'});
        const rubric = collectRubricFromForm(rb);
        const weightSum = rubric.reduce((a, r) => a + (parseInt(r.weight,10)||0), 0);
        if (rubric.length && weightSum !== 100) {
          return showToast('La r√∫brica debe sumar 100% (actual: '+weightSum+'%)', {type:'warn'});
        }
        const list=db.get(DB_KEYS.activities);
        if(idEditing){
          const i=list.findIndex(x=>x.id===idEditing);
          if(i>=0) list[i]={...list[i],courseId,titulo,descripcion,fechaEntrega,rubric};
          showToast('Actividad actualizada',{type:'ok'});
        }else{
          const id='A-'+Math.random().toString(36).slice(2,6).toUpperCase();
          list.push({id,courseId,titulo,descripcion,fechaEntrega,rubric});
          showToast('Actividad creada',{type:'ok'});
        }
        db.set(DB_KEYS.activities,list); el('#a_editing').value=''; render();
      };
      el('#btnClearAct').onclick=()=>{
        el('#a_editing').value='';
        ['#a_title','#a_desc','#a_due'].forEach(function(s){ const x=el(s); if(x) x.value=''; });
        rb.innerHTML=''; addRubricRow(rb,'Criterio 1','60'); addRubricRow(rb,'Criterio 2','40');
        showToast('Formulario limpio',{type:'warn'});
      };
      root.querySelectorAll('button[data-edit-act]').forEach(b=>{
        b.onclick=()=>{
          const id=b.getAttribute('data-edit-act');
          const a=db.get(DB_KEYS.activities).find(x=>x.id===id);
          if(!a) return;
          el('#a_editing').value=a.id; el('#a_course').value=a.courseId; el('#a_title').value=a.titulo;
          el('#a_desc').value=a.descripcion||''; el('#a_due').value=a.fechaEntrega||'';
          rb.innerHTML='';
          (a.rubric||[{name:'Criterio 1',weight:60},{name:'Criterio 2',weight:40}]).forEach(r=> addRubricRow(rb,r.name,r.weight));
          window.scrollTo({top:0,behavior:'smooth'});
        };
      });
      root.querySelectorAll('button[data-del-act]').forEach(b=>{
        b.onclick=()=>{
          const id=b.getAttribute('data-del-act');
          if(!confirm('¬øEliminar la actividad '+id+'?')) return;
          const list=db.get(DB_KEYS.activities).filter(x=>x.id!==id);
          db.set(DB_KEYS.activities,list);
          showToast('Actividad eliminada',{type:'warn'});
          render();
        };
      });

      // Reporte por curso + PDF + FAB
      const repSel = el('#rep_course');
      const repBox = el('#reportBox');
      const setReport = ()=> repBox.innerHTML = courseReportHTML(repSel.value);
      setReport();
      repSel.onchange = setReport;
      el('#rep_pdf').onclick = ()=> openCoursePDF(repSel.value);
      el('#fab').onclick = ()=> openCoursePDF(repSel.value);

      el('#exportCSV').onclick=exportCSV;
    }

    // Tabla de entregas (docente) con r√∫brica
    function renderSubmissionsTableForDocente(){
      const subs=db.get(DB_KEYS.submissions), grades=db.get(DB_KEYS.grades), acts=db.get(DB_KEYS.activities);
      if(!subs.length) return '<p class="muted">A√∫n no hay entregas.</p>';
      return '<table>'+
        '<thead><tr><th>Actividad</th><th>Alumno</th><th>Contenido</th><th>R√∫brica</th><th>Total</th><th>Comentario</th><th>Acci√≥n</th></tr></thead>'+
        '<tbody>'+
          subs.map(s=>{
            const g=grades.find(x=>x.submissionId===s.id) || {};
            const act=acts.find(a=>a.id===s.activityId);
            const rubric=act?.rubric||[];
            const inputs=rubric.map(function(r,i){
              return '<label class="chip">'+r.name+' ('+r.weight+'%) <input type="number" min="0" max="100" style="width:70px" data-rscore="'+s.id+'-'+i+'" placeholder="0-100"></label>';
            }).join('<br>');
            const prog='<div class="progress"><span id="p-'+s.id+'"></span></div>';
            return '<tr>'+
              '<td>'+s.activityId+'</td>'+
              '<td>'+s.alumno+'</td>'+
              '<td>'+(s.url||s.texto||s.fileName||'-')+'</td>'+
              '<td>'+(rubric.length? inputs : '<span class="muted">‚Äî</span>')+'</td>'+
              '<td id="t-'+s.id+'">'+(g.score ?? '-')+' '+prog+'</td>'+
              '<td id="c-'+s.id+'" class="hint">'+(g.comment ?? '')+'</td>'+
              '<td class="table-actions">'+
                '<button data-calc="'+s.id+'" class="btn">Calcular</button>'+
                '<button data-grade="'+s.id+'" class="btn primary">Guardar</button>'+
              '</td>'+
            '</tr>';
          }).join('')+
        '</tbody>'+
      '</table>';
    }

    // Export CSV
    function exportCSV(){
      const subs=db.get(DB_KEYS.submissions), grades=db.get(DB_KEYS.grades);
      const rows=[["Actividad","Alumno","Contenido","Calificaci√≥n","Comentario","Fecha"]];
      subs.forEach(s=>{
        const g=grades.find(x=>x.submissionId===s.id)||{};
        rows.push([s.activityId,s.alumno,s.url||s.texto||s.fileName||'-', g.score??'Pendiente', g.comment||'', new Date(s.fecha).toLocaleString()]);
      });
      const csv=rows.map(r=>r.map(v=>'"'+String(v).replace(/"/g,'""')+'"').join(',')).join('\n');
      const a=document.createElement('a');
      a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'}));
      a.download='calificaciones.csv';
      a.click();
      URL.revokeObjectURL(a.href);
      showToast('CSV exportado',{type:'ok'});
    }

    /* ==================== ALUMNO (sin mostrar diagn√≥stico) ==================== */
    function renderAlumno(root,session){
      const email=session.email;
      const courses=db.get(DB_KEYS.courses).filter(c=>(c.alumnos||[]).includes(email));
      const acts=db.get(DB_KEYS.activities);
      const surveys=db.get(DB_KEYS.surveys);
      const mySurvey=surveys.find(s=>s.email===email)?.answers || {};

      root.innerHTML =
        '<h2>Alumno</h2>'+
        '<div class="grid2">'+
          '<div class="card">'+
            '<h3>Estado de √°nimo</h3>'+
            '<div class="table-actions">'+
              '<button data-mood="üôÇ" class="btn">üôÇ</button>'+
              '<button data-mood="üòê" class="btn">üòê</button>'+
              '<button data-mood="üòü" class="btn">üòü</button>'+
              '<button data-mood="üòî" class="btn">üòî</button>'+
            '</div>'+
            '<input id="moodText" placeholder="Cu√©ntame en una frase..."/>'+
            '<div style="margin-top:.5rem"><button id="sendMood" class="btn primary">Enviar</button></div>'+
            '<p id="moodReply" class="hint"></p>'+
          '</div>'+
          /* No envolvemos en otra .card: la funci√≥n ya devuelve tarjeta completa */
          renderSurveyHTML(mySurvey)+
        '</div>'+
        '<div class="card">'+
          '<div class="toolbar"><h3 style="margin:0">Mis cursos</h3></div>'+
          '<ul>'+courses.map(c=>'<li>'+c.id+' ¬∑ '+c.nombre+' <span class="muted">('+c.horario+')</span></li>').join('')+'</ul>'+
        '</div>'+
        '<div class="card">'+
          '<div class="toolbar"><h3 style="margin:0">Actividades</h3><input id="al_filter" placeholder="Filtrar..."/></div>'+
          '<table id="al_table"><thead><tr><th>ID</th><th>Curso</th><th>T√≠tulo</th><th>Entrega</th><th>Acci√≥n</th></tr></thead><tbody>'+
            acts.map(a=>'<tr>'+
              '<td>'+a.id+'</td><td>'+a.courseId+'</td><td>'+a.titulo+'</td>'+
              '<td>'+fmtDate(a.fechaEntrega)+' '+(a.fechaEntrega?'<span class="pill">'+daysLeft(a.fechaEntrega)+'</span>':'')+'</td>'+
              '<td class="table-actions"><button data-submit-link="'+a.id+'" class="btn">Link</button><button data-submit-text="'+a.id+'" class="btn">Texto</button><button data-submit-file="'+a.id+'" class="btn">Archivo</button></td>'+
            '</tr>').join('')+
          '</tbody></table>'+
        '</div>'+
        '<div class="card">'+
          '<h3>Mis calificaciones</h3>'+
          renderGradesForAlumno(session)+
        '</div>'+
        '<div class="card">'+
          '<h3>Asistente IA (demo local)</h3>'+
          '<div class="chat-box">'+
            '<div id="chatMessages" class="chat-messages"></div>'+
            '<div class="chat-input">'+
              '<input id="chatText" placeholder="Escribe tu duda... (ej. ¬øc√≥mo puedo mejorar mi concentraci√≥n?)">'+
              '<button id="chatSend" class="btn primary">Enviar</button>'+
            '</div>'+
          '</div>'+
          '<div class="quick" style="margin-top:.5rem">'+
            '<button class="btn" data-q="¬øQu√© entregas tengo esta semana?">Entregas esta semana</button>'+
            '<button class="btn" data-q="Gen√©rame un plan con pausas y checklist.">Plan r√°pido</button>'+
            '<button class="btn" data-q="¬øC√≥mo puedo manejar la ansiedad antes de ex√°menes?">Ansiedad</button>'+
            '<button class="btn" data-q="/ayuda">/ayuda</button>'+
          '</div>'+
        '</div>';

      // Filtro actividades
      attachFilter('#al_filter','#al_table');

      // √Ånimo
      let currentMood='üòê';
      document.querySelectorAll('[data-mood]').forEach(b=> b.onclick=()=>{ currentMood=b.getAttribute('data-mood'); el('#moodText').value=currentMood; });
      el('#sendMood').onclick=()=>{
        const text=el('#moodText').value.trim(); logMood(email,currentMood,text);
        el('#moodReply').innerHTML=coachReply(currentMood);
        showToast('√Ånimo registrado',{type:'ok'});
      };

      // Entregas
      root.querySelectorAll('button[data-submit-link]').forEach(btn=> btn.onclick=()=>{
        const actId=btn.getAttribute('data-submit-link'); const url=prompt('Enlace a tu entrega:'); if(!url) return;
        createSubmission({activityId:actId, alumno:email, url});
        showToast('Entrega registrada',{type:'ok'}); render();
      });
      root.querySelectorAll('button[data-submit-text]').forEach(btn=> btn.onclick=()=>{
        const actId=btn.getAttribute('data-submit-text'); const texto=prompt('Respuesta breve:')||''; if(!texto) return;
        createSubmission({activityId:actId, alumno:email, texto});
        showToast('Entrega registrada',{type:'ok'}); render();
      });
      root.querySelectorAll('button[data-submit-file]').forEach(btn=> btn.onclick=()=>{
        const actId=btn.getAttribute('data-submit-file');
        const input=document.createElement('input'); input.type='file';
        input.onchange=e=>{
          const file=e.target.files[0]; if(!file) return;
          const r=new FileReader();
          r.onload=()=>{ createSubmission({activityId:actId, alumno:email, fileName:file.name, fileData:r.result}); showToast('Entrega registrada',{type:'ok'}); render(); };
          r.readAsDataURL(file);
        };
        input.click();
      });

      // Encuesta: confidencial ‚Üí solo docente ver√° etiquetas/plan
      el('#saveSurvey').onclick=()=>{
        const ans={};
        SURVEY_QUESTIONS.forEach(q=>{
          if(q.type==='likert'){
            const sel = document.querySelector('input[name="'+q.id+'"]:checked');
            if(sel) ans[q.id]=sel.value;
          }else{
            const v = el('#'+q.id)?.value || '';
            if(v) ans[q.id]=v;
          }
        });
        const arr=db.get(DB_KEYS.surveys);
        const i=arr.findIndex(s=>s.email===email);
        const rec={email, ts:new Date().toISOString(), answers:ans};
        if(i>=0) arr[i]=rec; else arr.push(rec);
        db.set(DB_KEYS.surveys,arr);

        const evalRes=scoreRiskFromSurvey(ans);
        const plan=buildPlan(evalRes.needs);
        setProfile({email, needs:evalRes.needs, plan});
        showToast('Encuesta guardada',{type:'ok'});
        render();
      };
      el('#clearSurvey').onclick=()=>{
        const arr=db.get(DB_KEYS.surveys).filter(s=>s.email!==email);
        db.set(DB_KEYS.surveys,arr);
        showToast('Encuesta limpiada',{type:'warn'}); render();
      };

      // === Chat IA local (dentro de renderAlumno) ===
      {
        const chatMsgsEl = el('#chatMessages');
        const chatInput  = el('#chatText');
        const chatSend   = el('#chatSend');

        if (!chatMsgsEl || !chatInput || !chatSend) return;

        function renderChatHistory(){
          const hist = loadChatMsgs(email) || [];
          chatMsgsEl.innerHTML = '';
          hist.forEach(m => pushMsg(m.role, m.text, new Date(m.ts), false));
        }
        function pushMsg(role, rawText, ts = new Date(), persist = true){
          const wrap = document.createElement('div');
          wrap.className = 'msg ' + (role === 'user' ? 'user' : 'bot');
          wrap.innerHTML = '<div class="bubble">' + md(rawText) + '</div><div class="meta">' + ts.toLocaleTimeString() + '</div>';
          chatMsgsEl.appendChild(wrap);
          chatMsgsEl.scrollTop = chatMsgsEl.scrollHeight;
          if (persist) saveChatMsg(email, role, rawText);
        }
        function showTyping(){
          const w = document.createElement('div');
          w.className = 'msg bot'; w.id = 'typingRow';
          w.innerHTML = '<div class="bubble"><span class="typing"><i></i><i></i><i></i></span></div>';
          chatMsgsEl.appendChild(w);
          chatMsgsEl.scrollTop = chatMsgsEl.scrollHeight;
        }
        function hideTyping(){ const n = el('#typingRow'); if (n) n.remove(); }

        function listUpcomingTasks(limitDays = 7){
          const upcoming = db.get(DB_KEYS.activities)
            .map(a => ({ a, d: a.fechaEntrega ? new Date(a.fechaEntrega + 'T23:59:59') : null }))
            .filter(x => x.d)
            .sort((x,y) => x.d - y.d)
            .filter(x => {
              const days = (x.d - new Date()) / 86400000;
              return days >= 0 && days <= limitDays;
            });
          if (!upcoming.length) return 'No tienes entregas en los pr√≥ximos ' + limitDays + ' d√≠as. ¬°Buen trabajo! üéâ';
          return 'Pr√≥ximos ' + limitDays + ' d√≠as:\n- ' +
            upcoming.map(x => (x.a.id + ' ¬∑ ' + x.a.titulo + ' (' + fmtDate(x.a.fechaEntrega) + ')')).join('\n- ');
        }
        function avgGradeFor(mail){
          const subs   = db.get(DB_KEYS.submissions).filter(s => s.alumno === mail);
          const grades = db.get(DB_KEYS.grades);
          const got = subs.map(s => grades.find(g => g.submissionId === s.id)?.score)
                          .filter(v => typeof v === 'number');
          return got.length ? Math.round(got.reduce((a,b) => a + b, 0) / got.length) : null;
        }
        function handleSlash(cmd){
          const lc = cmd.trim().toLowerCase();
          if (lc === '/ayuda')
            return '**Comandos**:\n- /resumen ¬∑ vista r√°pida\n- /tips ¬∑ plan express\n- /pdf ¬∑ abre reporte del curso\n- /borrar ¬∑ limpia el chat\n- /export ¬∑ descarga JSON';
          if (lc === '/resumen'){
            const avg = avgGradeFor(email);
            return '**Resumen**\n' + listUpcomingTasks(7) + '\n\nPromedio: **' + (avg ?? '‚Äî') + '**';
          }
          if (lc === '/tips'){
            return '**Plan express**\n- Pomodoro 25/5\n- Checklist (3 subtareas)\n- Respiraci√≥n 4-4-6 antes de entregar';
          }
          if (lc === '/pdf'){
            const selDoc = db.get(DB_KEYS.courses)[0]?.id || 'C-001';
            openCoursePDF(selDoc);
            return 'Abriendo reporte del curso en una nueva pesta√±a‚Ä¶';
          }
          if (lc === '/borrar'){ clearChatMsgs(email); chatMsgsEl.innerHTML = ''; return 'Conversaci√≥n borrada ‚úÖ'; }
          if (lc === '/export'){ const data = loadChatMsgs(email); downloadJSONFile('chat_' + email + '.json', data); return 'Descarga iniciada (JSON).'; }
          return null;
        }
        function replySmart(q){
          const txt = q.trim();
          if (txt.startsWith('/')) { const r = handleSlash(txt); if (r) return r; }
          const lowTxt = txt.toLowerCase();
          if (/entregas|tareas|semana|hoy|pr√≥xim|vence|deadline/i.test(lowTxt))
            return listUpcomingTasks(7);
          if (/pdf|reporte/i.test(lowTxt))
            return 'Puedo abrir el reporte PDF del curso seleccionado.';
          if (/calificaci|nota|promedio/i.test(lowTxt)){
            const avg = avgGradeFor(email);
            return (avg != null) ? ('Tu promedio actual es **' + avg + '**.') : 'A√∫n no tienes calificaciones registradas.';
          }
          if (/ayuda|c√≥mo|que puedo|help/i.test(lowTxt))
            return '**Te ayudo con:**\n- Entregas ‚Üí *qu√© vence esta semana*\n- Calificaciones ‚Üí *promedio*\n\n**Comandos**: /resumen /tips /pdf /borrar /export';
          return '¬øPrefieres que revise tus pr√≥ximas entregas o armamos un plan r√°pido?';
        }
        function chatSendNow(){
          const txt = (chatInput.value || '').trim();
          if (!txt) return;
          pushMsg('user', txt);
          chatInput.value = '';
          showTyping();
          setTimeout(() => { hideTyping(); const resp = replySmart(txt); pushMsg('bot', resp); }, 420);
        }
        chatSend.onclick = chatSendNow;
        chatInput.addEventListener('keydown', e => { if (e.key === 'Enter'){ e.preventDefault(); chatSendNow(); } });
        const quickBtns = document.querySelectorAll('.quick [data-q]');
        if (quickBtns && quickBtns.length){
          quickBtns.forEach(b => b.onclick = () => { chatInput.value = b.getAttribute('data-q') || ''; chatSendNow(); });
        }
        renderChatHistory();
        if ((loadChatMsgs(email) || []).length === 0){
          pushMsg('bot', 'Hola ' + (session.name) + '. Puedo revisar tus entregas o darte tips de estudio. Escribe **/ayuda** para ver comandos.');
        }
      }
    }

    // utilidades usadas por alumno / docente
    function renderPlan(plan){
      const hints = Array.isArray(plan?.hints) ? plan.hints : [];
      const strategies = Array.isArray(plan?.strategies) ? plan.strategies : [];
      return '<div><div class="pill">Modo: ' + (plan?.mode?.gamify ? 'Gamificado' : '') + ' ' + (plan?.mode?.focus || '') +
             '</div><ul class="hint">' + hints.map(h => '<li>‚Ä¢ ' + h + '</li>').join('') +
             '</ul><p class="muted">Estrategias: ' + strategies.join(' ¬∑ ') + '</p></div>';
    }
    function coachReply(mood){
      const low = /üòü|üòî/.test(mood);
      if (low) return '<span class="bad">Gracias por compartir.</span> Prueba 3 respiraciones profundas. ¬øAvisamos a tu docente?';
      return '<span class="ok">¬°S√∫per!</span> Mant√©n el ritmo.';
    }
    function renderGradesForAlumno(session){
      const subs   = db.get(DB_KEYS.submissions).filter(s => s.alumno === session.email);
      const grades = db.get(DB_KEYS.grades);
      if (!subs.length) return '<p class="muted">A√∫n no tienes entregas.</p>';
      return '<table><thead><tr><th>Actividad</th><th>Enviado</th><th>Calificaci√≥n</th></tr></thead><tbody>' +
        subs.map(s => {
          const g = grades.find(x => x.submissionId === s.id);
          return '<tr><td>' + s.activityId + '</td><td>' + new Date(s.fecha).toLocaleString() + '</td><td>' + (g ? g.score : 'Pendiente') + '</td></tr>';
        }).join('') +
      '</tbody></table>';
    }
    function createSubmission({activityId, alumno, url=null, texto=null, fileName=null, fileData=null}){
      const list = db.get(DB_KEYS.submissions);
      list.push({
        id:'S-' + Math.random().toString(36).slice(2,6).toUpperCase(),
        activityId, alumno, url, texto, fileName, fileData, fecha:new Date().toISOString()
      });
      db.set(DB_KEYS.submissions, list);
    }

    /* ==================== Utilidades de tabla ==================== */
    const state={sort:{},page:{}};
    function attachFilter(inputSel, tableSel){
      const input=el(inputSel), table=el(tableSel); if(!input||!table) return;
      input.addEventListener('input',()=>{
        const q=input.value.toLowerCase();
        table.querySelectorAll('tbody tr').forEach(tr=>{
          tr.style.display= tr.textContent.toLowerCase().includes(q)? '':'none';
        });
      });
    }
    function paginate(key, rows, perPage=6){
      const page=state.page[key]||1;
      const total=Math.max(1,Math.ceil(rows.length/perPage));
      const start=(page-1)*perPage; return {slice:rows.slice(start,start+perPage), total, page};
    }
    function renderPagination(containerSel,key,total){
      const c=el(containerSel); if(!c) return; const page=state.page[key]||1;
      c.innerHTML='<div class="toolbar" style="justify-content:flex-end;gap:.4rem">'+
        '<button '+(page<=1?'disabled':'')+' data-pg="prev" class="btn">‚óÄ</button>'+
        '<span class="muted">P√°gina '+page+' / '+total+'</span>'+
        '<button '+(page>=total?'disabled':'')+' data-pg="next" class="btn">‚ñ∂</button>'+
      '</div>';
      c.querySelectorAll('button[data-pg]').forEach(b=>{
        b.onclick=()=>{ const dir=b.getAttribute('data-pg'); const np=dir==='prev'?Math.max(1,page-1):Math.min(total,page+1); state.page[key]=np; render(); };
      });
    }
    function sortRows(key,list,prop){
      const cur=state.sort[key]||{key:null,dir:1}; const dir=(cur.key===prop)? -cur.dir:1; state.sort[key]={key:prop,dir};
      list.sort((a,b)=>{const va=(a[prop]??'').toString().toLowerCase(); const vb=(b[prop]??'').toString().toLowerCase(); return va>vb?dir:va<vb?-dir:0;});
    }

    /* ==================== Eventos globales (r√∫brica) ==================== */
    document.addEventListener('click',(e)=>{
      const calcId = e.target?.getAttribute?.('data-calc');
      if(calcId){
        const subs = db.get(DB_KEYS.submissions);
        const acts = db.get(DB_KEYS.activities);
        const sub = subs.find(s=>s.id===calcId);
        const act = acts.find(a=>a.id===sub?.activityId);
        const rubric = act?.rubric||[];
        const scores = rubric.map((r,i)=> parseInt((document.querySelector('[data-rscore="'+calcId+'-'+i+'"]')?.value)||'0',10));
        const total = totalFromRubric(rubric, scores);
        const comment = genComments(rubric, scores);
        if(total!=null){ const t=el('#t-'+calcId); if(t){ t.firstChild.nodeValue = String(total)+' '; } const p=el('#p-'+calcId); if(p) setProgress(p,total); }
        if(comment){ const c=el('#c-'+calcId); if(c) c.textContent = comment; }
        showToast('C√°lculo aplicado',{type:'ok'});
        return;
      }

      const id=e.target?.getAttribute?.('data-grade'); if(!id) return;
      const subs = db.get(DB_KEYS.submissions);
      const acts = db.get(DB_KEYS.activities);
      const subRef = subs.find(s=>s.id===id);
      const act = acts.find(a=>a.id===subRef?.activityId);
      const rubric = act?.rubric||[];

      let score=null, comment='';
      if(rubric.length){
        const scores = rubric.map((r,i)=> parseInt((document.querySelector('[data-rscore="'+id+'-'+i+'"]')?.value)||'0',10));
        const total = totalFromRubric(rubric, scores);
        if(total==null) return showToast('Completa la r√∫brica',{type:'bad'});
        score = total; comment = genComments(rubric, scores);
      }else{
        const scoreInput = document.querySelector('input[data-score-for="'+id+'"]');
        score = scoreInput? parseInt(scoreInput.value,10): null;
      }
      if(score==null || Number.isNaN(score) || score<0 || score>100) return showToast('Puntaje inv√°lido (0-100)',{type:'bad'});

      const grades=db.get(DB_KEYS.grades); const idx=grades.findIndex(g=>g.submissionId===id);
      const rec = {submissionId:id, score, comment};
      if(idx>=0) grades[idx]=rec; else grades.push(rec);
      db.set(DB_KEYS.grades,grades);
      showToast('Calificaci√≥n guardada',{type:'ok'});
    });

    /* ==================== Botones top / tema / FAB / Landing ==================== */
    el('#registerBtn').onclick=register;
    el('#loginBtn').onclick=login;
    el('#logoutBtn').onclick=()=>{ clearSession(); showToast('Sesi√≥n cerrada',{type:'warn'}); render(); };
    el('#resetBtn').onclick=()=>{ db.clear(); showToast('Demo reiniciada',{type:'warn'}); render(); };
    el('#modeBtn').onclick=()=>{
      const cur=document.documentElement.getAttribute('data-theme')==='dark'?'dark':'light';
      const next=cur==='dark'?'light':'dark';
      document.documentElement.setAttribute('data-theme',next);
      localStorage.setItem(DB_KEYS.theme,next);
      render();
    };

    // Toggle mostrar/ocultar contrase√±a
    const pwd = el('#password');
    const tbtn = el('#togglePwd');
    if (tbtn && pwd) {
      tbtn.onclick = () => {
        const isPwd = pwd.type === 'password';
        pwd.type = isPwd ? 'text' : 'password';
        tbtn.textContent = isPwd ? 'üôà' : 'üëÅÔ∏è';
        pwd.focus();
      };
    }

    // CTA del hero
    const ctaStart = el('#ctaStart');
    const ctaDemo = el('#ctaDemo');
    if (ctaStart) ctaStart.onclick = () => {
      el('#loginView')?.scrollIntoView({behavior:'smooth', block:'start'});
    };
    if (ctaDemo) ctaDemo.onclick = () => {
      const email = el('#email'), pass = el('#password');
      if (email) email.value = 'doc@demo';
      if (pass) pass.value = 'doc';
      el('#loginView')?.scrollIntoView({behavior:'smooth', block:'start'});
    }

    // FAB se configura dentro de render()
    el('#fab').style.display='none';

    // Init
    render();
  </script>
</body>
</html>
